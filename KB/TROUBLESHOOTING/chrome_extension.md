# Chrome Extension Troubleshooting

> Stand: 2026-02-05

---

## System-Konfiguration (Windows)

### Dateipfade

| Datei | Pfad |
|-------|------|
| Native Messaging Host Config | `%LOCALAPPDATA%\Google\Chrome\User Data\NativeMessagingHosts\com.anthropic.claude_code_browser_extension.json` |
| Native Host Batch | `%USERPROFILE%\.claude\chrome\chrome-native-host.bat` |
| Claude Code CLI | `%APPDATA%\npm\node_modules\@anthropic-ai\claude-code\cli.js` |

### Native Messaging Host Config Inhalt

```json
{
  "name": "com.anthropic.claude_code_browser_extension",
  "description": "Claude Code Chrome Extension Native Host",
  "path": "C:\\Users\\andre\\.claude\\chrome\\chrome-native-host.bat",
  "type": "stdio",
  "allowed_origins": [
    "chrome-extension://fcoeoabgfenejglbffodgkkbkcdhcgfn/"
  ]
}
```

### Native Host Batch Inhalt

```batch
@echo off
REM Chrome native host wrapper script
REM Generated by Claude Code - do not edit manually
"C:\Program Files\nodejs\node.exe" "C:\Users\andre\AppData\Roaming\npm\node_modules\@anthropic-ai\claude-code\cli.js" --chrome-native-host
```

---

## Architektur

### Prozesse (bei laufender Session)

| Prozess | Flag | Funktion |
|---------|------|----------|
| node.exe | `--dangerously-skip-permissions` | Haupt-CLI |
| node.exe | `--claude-in-chrome-mcp` | MCP Server fuer Chrome |

- MCP Server startet ca. 2 Sekunden nach Haupt-CLI (lazy loading)
- Kommunikation via Named Pipe: `\\.\pipe\claude-mcp-browser-bridge-<username>`

### Verbindungsweg

```
Claude Code CLI
    |
    v
MCP Server (--claude-in-chrome-mcp)
    | Named Pipe
    v
Chrome Extension
    | Native Messaging (stdio)
    v
Native Host Batch (--chrome-native-host)
```

---

## Bekannte Probleme

### 1. EADDRINUSE - Named Pipe blockiert

**Symptom:** Fehlermeldung "EADDRINUSE" beim Start

**Ursache:** Alte Node-Prozesse von vorherigen Sessions blockieren den Pipe

**Diagnose:**
```powershell
# Laufende Node-Prozesse anzeigen
Get-Process node | Select-Object Id, ProcessName, StartTime

# Details mit CommandLine
wmic process where "name='node.exe'" get ProcessId,CreationDate,CommandLine /format:list
```

**Loesung:**
```powershell
# Alte Prozesse beenden (NICHT die aktuelle Session!)
taskkill /F /PID <alte_pid>
```

**ACHTUNG:** Nur Prozesse mit altem Timestamp beenden!

---

### 2. Claude Desktop vs Claude Code Konflikt

**Symptom:** Extension verbindet sich mit falschem Backend

**Hintergrund:** Claude Desktop und Claude Code nutzen unterschiedliche Native Messaging Hosts:
- Claude Desktop: `com.anthropic.claude_browser_extension.json`
- Claude Code: `com.anthropic.claude_code_browser_extension.json` (mit "code")

**Diagnose:**
```powershell
dir "$env:LOCALAPPDATA\Google\Chrome\User Data\NativeMessagingHosts\*claude*"
```

**Loesung (Mac - von Community):**
```bash
# Claude Desktop Host deaktivieren
mv ~/Library/Application\ Support/Google/Chrome/NativeMessagingHosts/com.anthropic.claude_browser_extension.json \
   ~/Library/Application\ Support/Google/Chrome/NativeMessagingHosts/com.anthropic.claude_browser_extension.json.disabled
```

**Windows Aequivalent:**
```powershell
# Falls beide existieren und Desktop stoert:
ren "%LOCALAPPDATA%\Google\Chrome\User Data\NativeMessagingHosts\com.anthropic.claude_browser_extension.json" "com.anthropic.claude_browser_extension.json.disabled"
```

---

### 3. Native Host EADDRINUSE - HAUPTPROBLEM GEFUNDEN!

**Symptom:** `tabs_context_mcp` gibt "Browser extension is not connected" zurueck

**Ursache (verifiziert 2026-01-29):**

Beide Prozesse versuchen denselben Named Pipe zu belegen:

```
Claude Code startet:  --claude-in-chrome-mcp    → erstellt Listener auf Pipe
Chrome startet:       --chrome-native-host      → versucht AUCH Listener zu erstellen
                                                 → EADDRINUSE Fehler!
```

**Beweis:**
```bash
echo '{"type":"ping"}' | node cli.js --chrome-native-host
```
Ausgabe:
```
[Claude Chrome Native Host] Creating socket listener: \\.\pipe\claude-mcp-browser-bridge-andre
[Claude Chrome Native Host] Socket server error: Error: listen EADDRINUSE: address already in use
```

**Diagnose:** Das ist ein Bug/Architektur-Problem in Claude Code. Der Native Host sollte sich als CLIENT mit dem MCP-Server verbinden, nicht selbst einen Server erstellen.

**Workaround:** Claude Code 2.1.19 via npm installieren (funktioniert, getestet 2026-01-31):
```powershell
npm install -g @anthropic-ai/claude-code@2.1.19
```

**Manueller Patch auf neueren Versionen:** ✅ FUNKTIONIERT (getestet 2026-02-09, v2.1.37)

Die Funktion `cc4()` in cli.js sammelt Socket-Pfade, aber der Windows Named Pipe Pfad fehlt.

**Patch-Anleitung:**

1. cli.js Pfad finden:
```powershell
$cli = "$env:APPDATA\npm\node_modules\@anthropic-ai\claude-code\cli.js"
```

2. Backup erstellen:
```powershell
Copy-Item $cli "$cli.bak"
```

3. Patch anwenden (Node.js Script):
```javascript
const fs = require('fs');
const path = 'C:/Users/andre/AppData/Roaming/npm/node_modules/@anthropic-ai/claude-code/cli.js';
let content = fs.readFileSync(path, 'utf8');

const oldCode = 'if(Y!==z&&!A.includes(z))A.push(z);return A}function lCY()';
const pipePrefix = '\\\\\\\\.\\\\pipe\\\\';
const winFix = 'if(process.platform==="win32"){let w="' + pipePrefix + '"+K;if(!A.includes(w))A.push(w)}';
const newCode = 'if(Y!==z&&!A.includes(z))A.push(z);' + winFix + 'return A}function lCY()';

if (content.includes(oldCode)) {
  content = content.replace(oldCode, newCode);
  fs.writeFileSync(path, content, 'utf8');
  console.log('PATCH APPLIED');
}
```

4. Chrome + Claude Code neu starten

**Ergebnis:** Der Patch fuegt `\\.\pipe\claude-mcp-browser-bridge-<username>` zu den Socket-Pfaden hinzu.

**WICHTIG:** Patch muss nach jedem Update erneut angewendet werden!

**Alternative:** Claude Code 2.1.19 via npm (funktioniert ohne Patch):
```powershell
npm install -g @anthropic-ai/claude-code@2.1.19
```

**Auto-Update deaktivieren** (verhindert Ueberschreiben):
```json
// ~/.claude/settings.json
{
  "autoUpdates": false
}
```

**Status:** Bug-Report eingereicht, Root Cause gefunden, Fix ausstehend
- GitHub Issue: https://github.com/anthropics/claude-code/issues/21791
- Haupt-Issue: https://github.com/anthropics/claude-code/issues/21512
- Erstellt: 2026-01-29

**WICHTIG:** ~~Moeglicherweise verursacht durch Chrome 144 Update~~ → WIDERLEGT

---

### Root Cause Analyse (von kimchi-developer, 2026-02-02)

**Das Problem im Detail:**

In Version 2.1.20 wurde eine Multi-Socket-Architektur eingefuehrt. Zwei Funktionen verwalten Socket-Pfade:

1. **`Rj6()` (Native Host)** - Gibt korrekten Windows Named Pipe zurueck:
```javascript
function Rj6() {
  if (platform() === "win32")
    return `\\\\.\\pipe\\claude-mcp-browser-bridge-${username}`;
  return join(tmpDir(), `${process.pid}.sock`);
}
```

2. **`xQ4()` (MCP Server Socket Pool)** - **Windows-Support FEHLT:**
```javascript
function xQ4() {
  let paths = [];
  // Scannt nur Unix Socket Files und Temp-Verzeichnisse
  // Liefert: ["C:\\Users\\...\\Temp\\claude-mcp-browser-bridge-user", "/tmp/..."]
  // FEHLT: Windows Named Pipe Pfad!
  return paths;
}
```

**Resultat auf Windows:**
- Native Host hoert auf: `\\.\pipe\claude-mcp-browser-bridge-user` ✓
- MCP Server verbindet zu: `C:\Users\...\Temp\...` → **ENOENT** ✗

**Der Fix (noch nicht released):**
```javascript
function xQ4() {
  if (platform() === "win32") {
    return [`\\\\.\\pipe\\claude-mcp-browser-bridge-${username}`];
  }
  // existing Unix logic...
}
```

**Betroffene Versionen:**
- Letzte funktionierende: **2.1.19**
- Erste kaputte: **2.1.20** (Multi-Socket Architektur eingefuehrt)

**Source File (vermutlich):** `packages/cli/src/chrome-extension/socket-bridge.ts`

---

### Ausgeschlossene Ursachen (getestet 2026-01-30)

| Test | Ergebnis |
|------|----------|
| Chrome Downgrade (144 → 143) | ❌ Hat NICHT geholfen |
| Claude Code Downgrade | ❌ Hat NICHT geholfen |

**Fazit:** Problem liegt im Architektur-Bug selbst (Native Host erstellt Server statt Client-Verbindung), nicht in einer bestimmten Version.

---

### Verwandte GitHub Issues

| Issue | Beschreibung |
|-------|--------------|
| #21791 | Eigenes Issue (erstellt 2026-01-29) |
| #21512 | Windows EADDRINUSE / Pipe-Konflikt (Hauptthread) |
| #21337 | Windows Bridge / Native Messaging nicht verbunden |
| #21363 | Sammelthread Chrome Extension Windows 11 |
| #21607, #21426, #21796 | Weitere aehnliche Symptome |

---

### 4. Extension nicht verbunden - andere Ursachen

**Moegliche weitere Ursachen:**
- [ ] Chrome wurde nach Prozess-Neustart nicht neu gestartet
- [ ] Extension ist deaktiviert
- [ ] Extension hat falsche Permissions
- [ ] Native Host Batch ist nicht ausfuehrbar
- [ ] Firewall/Antivirus blockiert Named Pipe

**Pruefschritte:**
- Extension-Status in `chrome://extensions`
- Extension-Console-Logs (Rechtsklick > Inspect)
- Windows Event Log fuer Fehler

---

## Diagnose-Befehle Sammlung

```powershell
# Node-Prozesse mit Details
wmic process where "name='node.exe'" get ProcessId,CreationDate,CommandLine /format:list

# Native Host Configs auflisten
dir "$env:LOCALAPPDATA\Google\Chrome\User Data\NativeMessagingHosts\*claude*"

# Native Host Config lesen
type "$env:LOCALAPPDATA\Google\Chrome\User Data\NativeMessagingHosts\com.anthropic.claude_code_browser_extension.json"

# Batch-Script pruefen
type "$env:USERPROFILE\.claude\chrome\chrome-native-host.bat"

# Alle Node-Prozesse beenden (Vorsicht!)
taskkill /F /IM node.exe
```

---

## Extension-Konfiguration (verifiziert 2026-01-29)

### Installierte Extension

| Feld | Wert |
|------|------|
| Name | Claude |
| Version | 1.0.41 |
| ID | `fcoeoabgfenejglbffodgkkbkcdhcgfn` |
| Groesse | 10,1 MB |
| Quelle | Chrome Web Store |
| Status | Aktiviert |

### Berechtigungen (alle vorhanden)

- Auf das Backend fuer Seiten-Debugger zugreifen
- Alle deine Daten auf allen Websites lesen und aendern
- Benachrichtigungen einblenden
- Downloads verwalten
- **Mit zusammenarbeitenden nativen Anwendungen kommunizieren** (kritisch!)
- Tabgruppen ansehen und verwalten

### Websitezugriff

- Zugriff: "Auf allen Websites"
- Zugriff auf Datei-URLs: AUS
- Fehler erfassen: AUS
- Im Inkognitomodus: AUS

### ID-Abgleich

Native Host Config `allowed_origins` muss mit Extension-ID uebereinstimmen:
- Config: `chrome-extension://fcoeoabgfenejglbffodgkkbkcdhcgfn/` ✓
- Chrome: `fcoeoabgfenejglbffodgkkbkcdhcgfn` ✓

---

## Offene Fragen

1. Warum verbindet sich die Extension nicht, obwohl alles korrekt aussieht?
2. Service Worker Logs pruefen - Fehler?
3. Muss Chrome mit speziellen Flags gestartet werden?

---

## ~~Workaround: Chrome Downgrade auf 143~~ (FUNKTIONIERT NICHT)

> **Update 2026-01-30:** Downgrade auf Chrome 143 hat das Problem NICHT behoben.
> Der Workaround bleibt hier nur zur Dokumentation.

### Voraussetzungen

- Chrome Sync aktiv (Daten sichern)
- Lesezeichen exportieren (Backup)

### Schritt 1: Auto-Update deaktivieren (als Administrator)

```cmd
sc config "GoogleUpdaterService144.0.7547.0" start= disabled
sc config "GoogleUpdaterInternalService144.0.7547.0" start= disabled
```

**Hinweis:** Service-Namen koennen variieren. Pruefen mit:
```cmd
sc query state= all | findstr /i google
```

### Schritt 2: Chrome deinstallieren

```
Windows Einstellungen → Apps → Google Chrome → Deinstallieren
```

### Schritt 3: Chrome-Daten loeschen

```
%LOCALAPPDATA%\Google\Chrome
```
Ordner loeschen oder umbenennen zu `Chrome_backup`

### Schritt 4: Chrome 143 installieren

Download: https://google-chrome.en.uptodown.com/windows/versions

Suche nach Version **143.x** (z.B. 143.0.6917.185)

### Schritt 5: Lesezeichen importieren

```
Chrome → ⋮ → Lesezeichen → Lesezeichen-Manager → ⋮ → Lesezeichen importieren
```

---

## Auto-Update deaktivieren

**Problem:** Claude Code hat einen eingebauten Auto-Updater, der unabhaengig von npm funktioniert. Selbst nach `npm install -g @anthropic-ai/claude-code@2.1.19` kann die Version automatisch auf eine kaputte Version aktualisiert werden.

**Loesung:** In `~/.claude/settings.json`:
```json
{
  "autoUpdates": false
}
```

**Hinweis:** Laut GitHub Issues (#9327, #11263) funktioniert diese Einstellung manchmal nicht zuverlaessig. Alternative: Umgebungsvariable setzen:
```powershell
# In PowerShell Profil oder System-Umgebungsvariablen:
$env:DISABLE_AUTOUPDATER = "1"
```

**Native vs npm Installation:**
- Native Installation (via `claude install`): Auto-Update im Hintergrund
- npm Installation: Kein npm-Auto-Update, ABER Claude-interner Updater aktiv
- Homebrew (Mac): Kein Auto-Update

---

## Changelog

- 2026-02-09: Manueller Patch auf v2.1.37 FUNKTIONIERT - cc4() Funktion gepatcht
- 2026-02-05: Manueller Patch auf 2.1.31 getestet - funktioniert NICHT (falscher Ansatz)
- 2026-02-03: Root Cause Analyse von kimchi-developer hinzugefuegt
- 2026-02-03: Auto-Update-Deaktivierung dokumentiert
- 2026-01-31: Workaround bestaetigt: npm-Version 2.1.19 funktioniert
- 2026-01-31: Fix muss von Claude Code (Anthropic) kommen, nicht Chrome
- 2026-01-30: Chrome 144 als Ursache WIDERLEGT (Downgrade hat nicht geholfen)
- 2026-01-30: Claude Code Downgrade hat ebenfalls nicht geholfen
- 2026-01-30: Verwandte GitHub Issues dokumentiert (#21512, #21337, #21363, etc.)
- 2026-01-29: Chrome Downgrade Anleitung hinzugefuegt
- 2026-01-29: Chrome 144 als moegliche Ursache identifiziert
- 2026-01-29: GitHub Issue #21791 erstellt
- 2026-01-29: Initiale Dokumentation aus Troubleshooting-Session
